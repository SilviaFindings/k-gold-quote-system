# 数据重新导入指南

## 问题说明

由于之前数据库表结构对ID长度有限制（只有36字符），而系统生成的复合ID可能达到74字符，导致部分数据无法同步到数据库。

## 解决方案

已创建以下三个新API端点来解决此问题：

### 1. 修复表结构 (/api/fix-schema)
**功能**：将数据库ID字段长度从36字符扩展到200字符，支持长ID。

**影响字段**：
- `products.id`
- `price_history.id`
- `price_history.product_id`

**操作步骤**：
1. 登录系统
2. 打开报价单页面
3. 点击"更多工具" → "修复表结构"
4. 确认操作

### 2. 清空云端数据 (/api/clean-all)
**功能**：清空数据库中所有用户数据，准备重新导入。

**操作步骤**：
1. 登录系统
2. 打开报价单页面
3. 点击"更多工具" → "清空云端数据"
4. 确认操作（⚠️ 此操作不可逆）

**清空内容**：
- 所有产品数据
- 所有价格历史记录
- 所有配置数据

### 3. 清除本地数据
**功能**：清空浏览器 localStorage 中的数据。

**操作步骤**：
1. 登录系统
2. 打开报价单页面
3. 点击"更多工具" → "清除本地数据"
4. 确认操作（⚠️ 此操作不可逆）

## 重新导入流程

### 方案一：从Excel重新导入（推荐）

**前提条件**：你手头有原始的Excel数据文件

**步骤**：
1. 先执行"修复表结构"操作
2. 再执行"清空云端数据"操作（如果数据库中有旧数据）
3. 点击"从Excel导入"按钮
4. 选择原始的Excel文件
5. 系统会自动识别并导入所有数据
6. 导入完成后，点击"同步到数据库"将数据保存到云端

### 方案二：从备份恢复

**前提条件**：你之前已备份数据到JSON文件

**步骤**：
1. 先执行"修复表结构"操作
2. 再执行"清空云端数据"操作（如果数据库中有旧数据）
3. 点击"更多工具" → "从备份恢复"
4. 选择备份的JSON文件
5. 系统会自动恢复所有数据
6. 恢复完成后，点击"同步到数据库"将数据保存到云端

### 方案三：保留本地数据，仅重新同步

**前提条件**：浏览器 localStorage 中还有完整数据

**步骤**：
1. 先执行"修复表结构"操作
2. 再执行"清空云端数据"操作（如果数据库中有旧数据）
3. 刷新页面，确保本地数据加载正常
4. 点击"同步到数据库"按钮
5. 等待同步完成

## 验证步骤

导入完成后，建议执行以下验证：

1. **查看数据统计**
   - 检查产品总数是否正确
   - 检查价格历史记录是否完整

2. **使用诊断功能**
   - 点击"更多工具" → "诊断数据"
   - 查看诊断报告，确认数据一致性

3. **测试数据**
   - 随机选择几个产品
   - 查看价格计算是否正确
   - 检查副号显示是否正常

## 注意事项

⚠️ **重要提醒**：

1. **操作顺序很重要**：必须先"修复表结构"，再"清空云端数据"，最后"同步数据"
2. **备份优先**：在清空任何数据之前，强烈建议先导出备份
3. **数据版本**：系统数据版本为 v3，会自动处理分类和子分类映射
4. **网络稳定**：同步过程中保持网络连接稳定，避免中断

## 常见问题

### Q1: 为什么需要修复表结构？
A1: 因为原来的ID字段长度限制（36字符）无法容纳系统生成的复合ID（最多74字符），导致数据无法同步。

### Q2: 修复表结构会影响现有数据吗？
A2: 不会，修复操作只是增加字段长度，不会删除或修改现有数据。

### Q3: 清空云端数据会删除本地数据吗？
A3: 不会，清空云端数据只删除数据库中的数据，浏览器 localStorage 中的数据会保留。

### Q4: 如果同步失败怎么办？
A4: 使用"诊断数据"功能检查问题，查看错误信息。常见问题包括：
- ID长度超限（已通过修复表结构解决）
- 数据格式错误（Excel格式不正确）
- 网络连接问题

### Q5: 能否部分导入数据？
A5: 可以，Excel导入时会跳过格式不正确的行，并显示导入结果。可以多次导入不同批次的Excel文件。

## 技术支持

如果遇到问题，请提供以下信息：
1. 浏览器控制台中的错误信息（F12打开控制台）
2. 诊断数据的结果
3. 具体的操作步骤和错误现象
