# 🎉 K金产品报价表 - 使用指南

## ✅ 系统介绍

这是一个专业的珠宝报价单管理系统，支持产品管理、价格计算、副号自动生成、数据备份导出、云端数据同步等功能。系统支持私有化部署，保护您的商业敏感信息。

---

## 🚀 快速开始

### 用户认证

首次使用需要登录系统：
- 在登录页面输入用户名和密码
- 登录成功后会进入报价单主页面
- 登录信息会保存在浏览器中，下次自动登录

### 产品分类结构

系统采用三级分类结构：
- **大类**：配件、宝石托、链条
- **小类**：如"耳环/耳逼"、"扣子"、"戒子托"等（共21个小分类）
- **显示格式**：在产品列表中，分类以"大类-小类"格式显示，如"配件-耳环"

### 本地运行步骤（如果您是开发者）

### 第1步：安装 Node.js

1. 访问 https://nodejs.org/
2. 下载并安装 Node.js（推荐 LTS 版本，如 v20.x 或 v22.x）
3. 验证安装：打开命令行/终端，输入：
   ```bash
   node --version
   # 应该显示 v20.x.x 或更高
   ```

### 第2步：安装 pnpm（推荐）

在命令行中输入：
```bash
npm install -g pnpm
```

（如果不想安装 pnpm，后续步骤中所有 `pnpm` 命令都改为 `npm` 即可）

### 第3步：进入项目目录

在命令行中进入您解压项目的目录：
```bash
cd k-gold-pricing-system
```

### 第4步：安装依赖

在项目目录下运行：
```bash
pnpm install
```

等待安装完成（通常需要 1-3 分钟，视网络速度而定）

### 第5步：启动应用

```bash
pnpm dev
```

看到类似以下提示表示启动成功：
```
✓ Ready in 2.5s
○ Local: http://localhost:5000
```

### 第6步：使用应用

打开浏览器访问：**http://localhost:5000**

🎉 现在您可以开始使用报价表了！

---

## 💡 首次使用建议

### 选项1：手动录入测试

1. 选择产品分类（如"耳环/耳逼"）
2. 填写产品信息：
   - 货号：TEST001
   - 名称：测试产品
   - 规格：测试规格
   - 重量：5
   - 人工成本：10
   - 金种：18K
3. 系统会自动计算批发价和零售价

### 选项2：Excel 批量导入

如果您有 Excel 数据：
1. 点击"Excel批量导入"按钮
2. 选择您的 Excel 文件
3. 设置导入选项（是否导入重量、人工成本等）
4. 点击"开始导入"

**Excel 文件要求：**
- 必须包含"货号"列
- 必须包含"名称"列
- 可选列：规格、重量、人工成本

### 重要：备份您的数据

⚠️ **数据存储位置**：所有数据保存在浏览器的 localStorage 中

⚠️ **数据风险**：清除浏览器数据会丢失所有数据！

✅ **建议操作**：定期点击"数据管理"中的"导出备份"按钮下载数据备份

---

## 🔧 常见问题解决

### Q1: 安装依赖时报错
**解决方案：**
1. 检查 Node.js 版本：`node --version`（需要 >= 18）
2. 如果版本过低，请升级 Node.js
3. 尝试使用 `npm install` 代替 `pnpm install`
4. 检查网络连接，确保能访问 npm 源

### Q2: 启动后访问 localhost:5000 无法打开
**解决方案：**
1. 确保命令行显示 "Ready in Xs" 和 "Local: http://localhost:5000"
2. 检查端口 5000 是否被其他程序占用
3. 尝试使用其他端口：修改 `package.json` 中的 `"dev": "next dev -p 5000"` 为 `"dev": "next dev -p 3000"`
4. 查看命令行是否有错误信息

### Q3: Excel 导入失败
**解决方案：**
1. 确保 Excel 文件格式正确（.xlsx 或 .xls）
2. 检查是否包含"货号"和"名称"列
3. 列名可以是中文或英文，但必须包含关键字"货号"和"名称"
4. 查看命令行的错误日志

### Q4: 修改代码后页面不更新
**解决方案：**
1. Next.js 支持热更新，保存文件后应该自动刷新
2. 如果未生效，按 `Ctrl+C` 停止服务器，然后重新运行 `pnpm dev`
3. 清除浏览器缓存后刷新页面

### Q5: 找不到某个分类的产品
**解决方案：**
1. 检查当前选中的分类（分类按钮为蓝色背景）
2. 点击其他有数字标记的分类按钮
3. 如果分类标记显示为0，说明该分类没有产品
4. 可以使用"批量修复分类"功能为无分类产品设置分类

### Q6: 导入Excel时提示"请先选择产品小类"
**说明：** 这是正常的保护机制，避免自动分类错误。
**解决方案：**
1. 在页面左侧找到"导入选项"区域
2. 点击"选择产品小类"下拉框
3. 选择要导入的产品小类（如"耳环/耳逼"）
4. 重新选择Excel文件导入

### Q7: 云端同步失败
**解决方案：**
1. 检查网络连接是否正常
2. 确认是否已登录系统
3. 查看浏览器控制台是否有错误信息
4. 尝试退出登录后重新登录

### Q8: 如何在多台设备间同步数据？
**解决方案：**
1. 在第一台电脑上开启"自动同步"，确保数据已上传到云端
2. 在第二台电脑登录同一个账号
3. 首次登录时会提示是否下载云端数据
4. 选择"合并下载"保留两台电脑的数据
5. 之后所有操作都会自动同步，保持两台电脑数据一致

### Q9: 清空云端数据后如何恢复？
**解决方案：**
1. 清空云端数据后，需要重新上传数据
2. 可以使用本地的备份文件恢复数据
3. 或者在有数据的设备上点击"上传到云端"
4. 其他设备可以通过"合并下载"或"替换下载"获取数据

---

## 📚 功能详解

### 产品分类管理
- **三级分类结构**：
  - 大类：配件、宝石托、链条（3个大类）
  - 小类：如"耳环/耳逼"、"扣子"、"戒子托"等（共21个小分类）
- **分类显示**：
  - 在产品列表中，分类以"大类-小类"格式显示，如"配件-耳环"
  - 使用蓝色标签样式，清晰易读
- **产品数量标记**：
  - 大类按钮显示该大类下的总产品数
  - 小类按钮显示该小类下的产品数
- **支持按分类筛选查看产品**

### 价格计算公式
```
材料成本 = 金价 × 重量 × 金种系数 × 材料损耗系数 × 材料费用系数
人工费用 = 人工成本 × 人工费用系数

批发价 = (材料成本 + 人工费用) × 利润系数 / 汇率
零售价 = (材料成本 + 人工费用 × 零售倍数) / 汇率
```

### 价格系数说明
- 金种系数：14K=0.586，18K=0.755
- 人工费用系数：零售=5，批发=3
- 材料损耗系数：1.15（默认）
- 材料费用系数：1.1（默认）
- 利润系数：1.25（默认）
- 汇率：5（默认，可自定义）

### Excel 导入
- 支持批量导入产品
- 智能识别列名称（支持中英文）
- 自动跳过已存在的货号
- 可选择是否导入重量和人工成本
- **重要**：导入前必须先选择产品小类，系统不会自动分类
- 如果忘记选择小类，会弹出警告提示

### Excel 导出
- 按货号横向展开，一个货号一行
- 支持导出批发价、零售价
- 已删除的产品不导出
- 可选择导出所有数据或仅选中项

### 数据备份和恢复
- 导出备份：将所有数据导出为 JSON 文件
- 恢复数据：从备份文件恢复数据
- 查看备份：预览备份文件内容
- 清除数据：清空所有数据

### 云端数据同步（新增）

#### 什么是云端同步？
云端同步可以将您的产品数据、价格系数、金价设置等自动保存到云端数据库，支持多设备访问和数据备份。

#### 如何使用云端同步？

**1. 上传到云端**
- 点击页面顶部的"☁️ 云端同步"按钮
- 选择"📤 上传到云端"
- 系统会将本地所有数据上传到云端数据库
- 上传的内容包括：所有产品、价格历史、金价设置、价格系数

**2. 从云端下载**
有两种下载模式：

**合并下载（推荐）**
- 将云端数据与本地数据合并，云端数据优先
- 适用场景：在不同设备上操作过，想保留所有数据
- 不会删除本地已有的产品

**替换下载**
- 完全使用云端数据替换本地数据
- ⚠️ 警告：会清空本地所有数据
- 适用场景：换新设备，或本地数据有误需要完全恢复
- 替换前建议先备份本地数据

**3. 检查云端数据**
- 快速检查云端是否有数据可以下载
- 如果云端有数据，会显示绿色提示"✓ 云端已有数据"

**4. 自动同步**
- 默认开启，数据变更时自动上传到云端
- 延迟3秒同步，避免频繁上传
- 可以在云端同步菜单中关闭自动同步

**5. 清空云端数据（危险操作）**
- 点击页面顶部的"☁️ 云端同步"按钮
- 选择"🗑️ 清空云端数据"
- 会弹出二次确认对话框
- ⚠️ 此操作不可恢复，会删除云端所有产品、历史记录和配置数据
- 清空前请确保已备份重要数据

#### 使用建议
- 首次使用时，建议先开启"自动同步"功能
- 在多设备间同步时，优先使用"合并下载"
- 换新设备时，使用"替换下载"导入云端数据
- 替换下载前，建议先通过"备份数据"按钮备份本地数据
- 可以关闭"自动同步"手动控制同步时机
- 清空云端数据前，请确保已备份重要数据

---

## 🎯 高级功能

### 批量更新价格
1. 更新金价或人工成本
2. 选择要更新的产品（勾选复选框）
3. 点击"更新选中产品价格"
4. 只更新选中的产品，不更新未选中的

### 价格系数自定义
点击"价格系数配置"展开面板，可以调整：
- 金种系数
- 人工费用系数
- 材料损耗系数
- 材料费用系数
- 利润系数
- 汇率

### 批量修复分类
当发现产品没有分类时（分类标记全部显示为0）：
1. 页面会显示"发现 X 个产品没有分类！"
2. 在下拉框中选择目标分类
3. 点击"批量修复分类"
4. 所有无分类产品将被设置为指定分类

---

## 💾 数据管理最佳实践

### 定期备份
建议：
- 每天导出一次备份
- 重要修改前先备份
- 使用有意义的文件名保存备份，如：`backup_2024-01-15.json`

### 备份文件存储
建议：
- 将备份文件保存在多个位置（电脑、云盘、U盘）
- 保留多个版本的备份，覆盖最近的7-30天

### 数据恢复注意事项
- 恢复操作会覆盖当前所有数据
- 恢复前先导出当前数据备份
- 确认备份文件来源可靠

---

## 🔒 安全建议

1. **不要在公共电脑上使用**：因为数据保存在浏览器中，容易被他人访问

2. **定期备份**：数据丢失后无法恢复

3. **使用现代浏览器**：Chrome、Edge、Firefox 等

4. **注意清除浏览器数据**：清除数据会丢失所有报价表数据

5. **密码保护**：如果电脑有多人使用，建议为操作系统设置密码

---

## 📞 技术支持

如果您遇到问题：

1. 查看本文档的"常见问题解决"部分
2. 检查命令行的错误日志
3. 确认 Node.js 版本和依赖安装是否正确
4. 尝试重启开发服务器

---

## 🎊 开始使用吧！

祝您使用愉快！

如有任何问题或建议，欢迎反馈。

---

## 📅 系统更新日志

### 2025-01-03
- ✅ 优化产品列表和历史记录表格的分类显示
  - 将大类和小列合并为一列显示为"大类-小类"格式
  - 界面更加简洁，表格列数减少
- ✅ 修复导入Excel时未选择小类导致警告窗口重复弹出的问题
  - 将验证逻辑移到文件读取之前
  - 避免警告窗口无法关闭的问题
- ✅ 添加清空云端数据功能
  - 在云端同步菜单中添加清空按钮
  - 更新操作指引，详细说明清空功能
  - 添加二次确认，防止误操作

### 历史更新
- 2025-01-03: 去掉副号破折号，简化货号显示
- 2025-01-03: 实现字母副号生成逻辑
- 2025-01-03: 修正副号生成逻辑
- 2025-01-03: 添加工费系数模式选择
- 2025-01-03: 实现产品副号自动生成功能
- 2025-01-03: 实现用户认证系统（JWT + bcrypt）
- 2025-01-03: 实现云端数据同步功能
- 2025-01-03: 添加数据备份导出功能（支持Excel和JSON）
- 2025-01-03: 实现智能分类识别功能
- 2025-01-03: 添加导入前小类选择功能

---

**最后更新时间**: 2025年1月3日
**当前版本**: v1.1.0
