From 63123f3b3081b637797ad7696ecd4099789f7034 Mon Sep 17 00:00:00 2001
From: Marblee <3440803185179952-Marblee@noreply.coze.cn>
Date: Wed, 7 Jan 2026 13:16:05 +0800
Subject: [PATCH 13/13] =?UTF-8?q?feat:=20=E9=93=B6=E5=88=B6=E5=93=81?=
 =?UTF-8?q?=E9=A1=B5=E9=9D=A2=E5=85=A8=E9=9D=A2=E4=BC=98=E5=8C=96=E4=B8=8E?=
 =?UTF-8?q?=E4=BF=AE=E5=A4=8D?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- åˆ›å»ºé“¶åˆ¶å“APIæ¥å£ /api/silver-syncï¼Œæ”¯æŒäº‘ç«¯åŒæ­¥åŠŸèƒ½
- æ·»åŠ è¿”å›é‡‘åˆ¶å“é¡µé¢çš„å¯¼èˆªæŒ‰é’®ï¼ˆé¡µé¢é¡¶éƒ¨ï¼‰
- æ–°å¢é“¶åˆ¶å“æ“ä½œæŒ‡å¼•ï¼Œå¸®åŠ©ç”¨æˆ·äº†è§£ä½¿ç”¨æµç¨‹
- é‡æ–°ç»„ç»‡é“¶åˆ¶å“é¡µé¢ç»“æ„ï¼ŒåŒºåˆ†äº§å“ç®¡ç†åŒºå’Œæ•°æ®ç®¡ç†åŒº
- åœ¨é“¶åˆ¶å“åˆ—è¡¨ä¸­æ·»åŠ äº§å“æŸ¥è¯¢åŠŸèƒ½ï¼ˆæ”¯æŒæŒ‰è´§å·å’Œäº§å“åç§°æœç´¢ï¼‰
- å®ç°Excelå¯¼å…¥æ—¶è‡ªåŠ¨é€‰æ‹©æœ€å³è¾¹æœ€æ–°åˆ—çš„åŠŸèƒ½ï¼ˆé‡‘åˆ¶å“å’Œé“¶åˆ¶å“ï¼‰
  * é“¶åˆ¶å“ï¼šè‡ªåŠ¨é€‰æ‹©æœ€å³è¾¹çš„é‡é‡ã€å·¥è´¹ã€é…ä»¶æˆæœ¬ã€çŸ³å¤´æˆæœ¬ã€ç”µé•€æˆæœ¬åˆ—
  * é‡‘åˆ¶å“ï¼šä¿®æ”¹findColumnIndexå‡½æ•°ï¼Œè¿”å›æœ€å³è¾¹åŒ¹é…çš„åˆ—ç´¢å¼•
- ä¿®å¤é“¶åˆ¶å“åŒæ­¥åŠŸèƒ½500é”™è¯¯é—®é¢˜
- ä¿®å¤TypeScriptç±»å‹é”™è¯¯ï¼ˆPriceHistoryManagerå’ŒAppConfigManageræ–¹æ³•è°ƒç”¨ï¼‰
---
 src/app/api/silver-sync/route.ts | 320 +++++++++++++++++--------------
 src/app/quote/page.tsx           |  52 ++++-
 src/app/silver-quote/page.tsx    | 215 ++++++++++++++-------
 3 files changed, 365 insertions(+), 222 deletions(-)

diff --git a/src/app/api/silver-sync/route.ts b/src/app/api/silver-sync/route.ts
index 9ffd84a..1f6780e 100644
--- a/src/app/api/silver-sync/route.ts
+++ b/src/app/api/silver-sync/route.ts
@@ -1,187 +1,213 @@
 import { NextRequest, NextResponse } from 'next/server';
 import { isAuthenticated } from '@/lib/auth';
+import { ProductManager } from '@/storage/database/productManager';
+import { PriceHistoryManager } from '@/storage/database/priceHistoryManager';
+import { appConfigManager } from '@/storage/database/appConfigManager';
+import { getDb } from 'coze-coding-dev-sdk';
+import { sql } from 'drizzle-orm';
 
-// é“¶åˆ¶å“æ•°æ®ç±»å‹å®šä¹‰
-interface SilverProduct {
-  id: string;
-  category: string;
-  subCategory: string;
-  productCode: string;
-  productName: string;
-  specification: string;
-  weight: number;
-  laborCost: number;
-  silverColor: string;
-  silverPrice: number;
-  wholesalePrice: number;
-  retailPrice: number;
-  accessoryCost: number;
-  stoneCost: number;
-  platingCost: number;
-  moldCost: number;
-  commission: number;
-  supplierCode: string;
-  remarks: string;
-  batchQuantity: number;
-  quantity: number;
-  quantityDate: string;
-  laborCostDate: string;
-  accessoryCostDate: string;
-  stoneCostDate: string;
-  platingCostDate: string;
-  moldCostDate: string;
-  commissionDate: string;
-  timestamp: string;
-  syncStatus: "synced" | "unsynced";
-}
-
-interface SilverPriceHistory {
-  id: string;
-  productId: string;
-  category: string;
-  subCategory: string;
-  productCode: string;
-  productName: string;
-  specification: string;
-  weight: number;
-  laborCost: number;
-  silverColor: string;
-  silverPrice: number;
-  wholesalePrice: number;
-  retailPrice: number;
-  accessoryCost: number;
-  stoneCost: number;
-  platingCost: number;
-  moldCost: number;
-  commission: number;
-  supplierCode: string;
-  remarks: string;
-  batchQuantity: number;
-  quantity: number;
-  quantityDate: string;
-  laborCostDate: string;
-  accessoryCostDate: string;
-  stoneCostDate: string;
-  platingCostDate: string;
-  moldCostDate: string;
-  commissionDate: string;
-  timestamp: string;
-}
-
-// ç®€å•çš„å†…å­˜å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒåº”è¯¥ä½¿ç”¨æ•°æ®åº“ï¼‰
-let silverDataStore: {
-  products: SilverProduct[];
-  history: SilverPriceHistory[];
-  silverPrice: number;
-  coefficients: any;
-} = {
-  products: [],
-  history: [],
-  silverPrice: 20,
-  coefficients: {},
-};
+// åˆ›å»ºç®¡ç†å™¨å®ä¾‹
+const productManager = new ProductManager();
+const priceHistoryManager = new PriceHistoryManager();
 
 /**
- * POST /api/silver-sync - ä¸Šä¼ é“¶åˆ¶å“æ•°æ®åˆ°äº‘ç«¯
- * Body:
- * - products: äº§å“æ•°ç»„
- * - priceHistory: ä»·æ ¼å†å²æ•°ç»„
- * - silverPrice: é“¶ä»·
- * - coefficients: ç³»æ•°å¯¹è±¡
+ * GET /api/silver-sync - è·å–é“¶åˆ¶å“æ•°æ®
  */
-export async function POST(request: NextRequest) {
+export async function GET(request: NextRequest) {
   try {
     const user = await isAuthenticated(request);
     if (!user) {
       return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
     }
 
-    const body = await request.json();
-    const { products, priceHistory, silverPrice, coefficients } = body;
-
-    console.log('ğŸ“¥ æ”¶åˆ°é“¶åˆ¶å“åŒæ­¥è¯·æ±‚:', {
-      userId: user.id,
-      userEmail: user.email,
-      productsCount: Array.isArray(products) ? products.length : 0,
-      historyCount: Array.isArray(priceHistory) ? priceHistory.length : 0,
-    });
+    // è·å–é“¶åˆ¶å“åˆ†ç±»åˆ—è¡¨
+    const silverCategories = ["é…ä»¶", "å®çŸ³æ‰˜", "é“¾æ¡", "å…¶å®ƒ"];
 
-    // å­˜å‚¨æ•°æ®åˆ°å†…å­˜ï¼ˆå®é™…åº”è¯¥ä½¿ç”¨æ•°æ®åº“ï¼‰
-    if (Array.isArray(products)) {
-      silverDataStore.products = products;
-    }
-    if (Array.isArray(priceHistory)) {
-      silverDataStore.history = priceHistory;
-    }
-    if (silverPrice !== undefined) {
-      silverDataStore.silverPrice = silverPrice;
-    }
-    if (coefficients) {
-      silverDataStore.coefficients = coefficients;
-    }
+    // è·å–æ‰€æœ‰é“¶åˆ¶å“
+    const allProducts = await productManager.getProducts(user.id, { limit: 10000 });
 
-    console.log('âœ… é“¶åˆ¶å“æ•°æ®ä¸Šä¼ æˆåŠŸ');
-    return NextResponse.json({ success: true });
-  } catch (error) {
-    console.error('âŒ é“¶åˆ¶å“åŒæ­¥å¤±è´¥:', error);
-    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
-  }
-}
+    // ç­›é€‰é“¶åˆ¶å“
+    const silverProducts = allProducts.filter(p => silverCategories.includes(p.category));
 
-/**
- * GET /api/silver-sync - ä»äº‘ç«¯ä¸‹è½½é“¶åˆ¶å“æ•°æ®
- */
-export async function GET(request: NextRequest) {
-  try {
-    const user = await isAuthenticated(request);
-    if (!user) {
-      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
-    }
+    // è·å–é“¶åˆ¶å“ä»·æ ¼å†å²
+    const allHistory = await priceHistoryManager.getHistoryByUserId(user.id, { limit: 10000 });
+    const silverHistory = allHistory.filter((h: any) => silverCategories.includes(h.category));
 
-    console.log('ğŸ“¤ å‘é€é“¶åˆ¶å“æ•°æ®:', {
-      userId: user.id,
-      userEmail: user.email,
-      productsCount: silverDataStore.products.length,
-      historyCount: silverDataStore.history.length,
-    });
+    // è·å–é“¶åˆ¶å“é…ç½®
+    const silverPriceConfig = await appConfigManager.getConfig(user.id, 'silver_price_config');
+    const silverPriceCoefficients = await appConfigManager.getConfig(user.id, 'silver_price_coefficients');
 
     return NextResponse.json({
-      products: silverDataStore.products,
-      history: silverDataStore.history,
-      silverPrice: silverDataStore.silverPrice,
-      coefficients: silverDataStore.coefficients,
+      products: silverProducts,
+      history: silverHistory,
+      silverPrice: silverPriceConfig?.configValue || 20,
+      coefficients: silverPriceCoefficients?.configValue || {},
     });
   } catch (error) {
-    console.error('âŒ é“¶åˆ¶å“ä¸‹è½½å¤±è´¥:', error);
+    console.error('è·å–é“¶åˆ¶å“æ•°æ®å¤±è´¥:', error);
     return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
   }
 }
 
 /**
- * DELETE /api/silver-sync - æ¸…é™¤äº‘ç«¯é“¶åˆ¶å“æ•°æ®
+ * POST /api/silver-sync - åŒæ­¥é“¶åˆ¶å“æ•°æ®åˆ°æ•°æ®åº“
+ * Body:
+ * - products: äº§å“æ•°ç»„
+ * - history: ä»·æ ¼å†å²æ•°ç»„
+ * - silverPrice: é“¶ä»·
+ * - coefficients: ä»·æ ¼ç³»æ•°
  */
-export async function DELETE(request: NextRequest) {
+export async function POST(request: NextRequest) {
   try {
     const user = await isAuthenticated(request);
     if (!user) {
       return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
     }
 
-    console.log('ğŸ—‘ï¸ æ¸…é™¤é“¶åˆ¶å“æ•°æ®:', {
+    const body = await request.json();
+    const { products, history, silverPrice, coefficients } = body;
+
+    let syncedProducts = 0;
+    let updatedProducts = 0;
+    let newProducts = 0;
+    let syncedHistory = 0;
+
+    console.log('ğŸ“¥ æ”¶åˆ°é“¶åˆ¶å“åŒæ­¥è¯·æ±‚:', {
       userId: user.id,
-      userEmail: user.email,
+      productsCount: Array.isArray(products) ? products.length : 0,
+      historyCount: Array.isArray(history) ? history.length : 0,
     });
 
-    silverDataStore = {
-      products: [],
-      history: [],
-      silverPrice: 20,
-      coefficients: {},
-    };
+    // 1. åŒæ­¥äº§å“æ•°æ®
+    if (Array.isArray(products) && products.length > 0) {
+      console.log('ğŸ“¦ å¼€å§‹åŒæ­¥é“¶åˆ¶å“äº§å“æ•°æ®...');
+      for (const product of products) {
+        try {
+          // æ•°æ®é¢„å¤„ç†ï¼šå°†é“¶åˆ¶å“å­—æ®µæ˜ å°„åˆ°é‡‘åˆ¶å“è¡¨ç»“æ„
+          const normalizedProduct = {
+            ...product,
+            // é“¶åˆ¶å“ä¸éœ€è¦karatï¼Œè®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²æˆ–é»˜è®¤å€¼
+            karat: '925', // é“¶åˆ¶å“é»˜è®¤925
+            goldColor: product.silverColor || 'é“¶è‰²', // é“¶åˆ¶å“çš„é¢œè‰²æ˜ å°„åˆ°goldColor
+            goldPrice: product.silverPrice || 20, // é“¶ä»·æ˜ å°„åˆ°goldPrice
+            // ç¡®ä¿å¿…å¡«å­—æ®µæœ‰å€¼
+            category: product.category || 'é…ä»¶',
+            subCategory: product.subCategory || '',
+            specification: product.specification || '',
+            supplierCode: product.supplierCode || '',
+            // ç¡®ä¿æ•°å€¼å­—æ®µæœ‰é»˜è®¤å€¼
+            weight: product.weight ?? 0,
+            laborCost: product.laborCost ?? 0,
+            wholesalePrice: product.wholesalePrice ?? 0,
+            retailPrice: product.retailPrice ?? 0,
+            accessoryCost: product.accessoryCost ?? 0,
+            stoneCost: product.stoneCost ?? 0,
+            platingCost: product.platingCost ?? 0,
+            moldCost: product.moldCost ?? 0,
+            commission: product.commission ?? 0,
+            // ç¡®ä¿å¯é€‰å­—æ®µæœ‰é»˜è®¤å€¼
+            orderChannel: product.orderChannel || null,
+            shape: product.shape || null,
+            // é“¶åˆ¶å“æ²¡æœ‰ç‰¹æ®Šç³»æ•°ï¼Œè®¾ç½®ä¸ºnull
+            specialMaterialLoss: null,
+            specialMaterialCost: null,
+            specialProfitMargin: null,
+            specialLaborFactorRetail: null,
+            specialLaborFactorWholesale: null,
+            // ç¡®ä¿æ—¶é—´æˆ³æ ¼å¼æ­£ç¡®
+            laborCostDate: product.laborCostDate ? new Date(product.laborCostDate) : new Date(),
+            accessoryCostDate: product.accessoryCostDate ? new Date(product.accessoryCostDate) : new Date(),
+            stoneCostDate: product.stoneCostDate ? new Date(product.stoneCostDate) : new Date(),
+            platingCostDate: product.platingCostDate ? new Date(product.platingCostDate) : new Date(),
+            moldCostDate: product.moldCostDate ? new Date(product.moldCostDate) : new Date(),
+            commissionDate: product.commissionDate ? new Date(product.commissionDate) : new Date(),
+            timestamp: product.timestamp ? new Date(product.timestamp) : new Date(),
+          };
+
+          // æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
+          if (!normalizedProduct.id) {
+            console.error('  âœ— äº§å“ç¼ºå°‘ id:', normalizedProduct.productCode);
+            continue;
+          }
 
-    return NextResponse.json({ success: true });
+          if (!normalizedProduct.productCode) {
+            console.error('  âœ— äº§å“ç¼ºå°‘ productCode:', normalizedProduct.id);
+            continue;
+          }
+
+          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé€šè¿‡ id å’Œ userIdï¼‰
+          const existing = await productManager.getProductById(product.id, user.id);
+          if (existing) {
+            // å·²å­˜åœ¨ï¼Œæ›´æ–°
+            await productManager.updateProduct(product.id, user.id, normalizedProduct);
+            updatedProducts++;
+            console.log(`  âœ“ æ›´æ–°äº§å“: ${normalizedProduct.productCode}`);
+          } else {
+            // ä¸å­˜åœ¨ï¼Œåˆ›å»º
+            const { userId: _userId, createdAt: _createdAt, updatedAt: _updatedAt, ...productToInsert } = normalizedProduct as any;
+            const dataToInsert = { ...productToInsert, id: product.id };
+            await productManager.createProductWithId(user.id, dataToInsert);
+            newProducts++;
+            console.log(`  + æ–°å»ºäº§å“: ${normalizedProduct.productCode} (id: ${product.id})`);
+          }
+          syncedProducts++;
+        } catch (e) {
+          console.error('  âœ— åŒæ­¥äº§å“å¤±è´¥:', product.productCode || product.id, e);
+        }
+      }
+      console.log(`âœ… é“¶åˆ¶å“äº§å“åŒæ­¥å®Œæˆ: æ–°å»º ${newProducts} ä¸ªï¼Œæ›´æ–° ${updatedProducts} ä¸ª`);
+    }
+
+    // 2. åŒæ­¥ä»·æ ¼å†å²
+    if (Array.isArray(history) && history.length > 0) {
+      console.log('ğŸ“ˆ å¼€å§‹åŒæ­¥é“¶åˆ¶å“ä»·æ ¼å†å²...');
+      for (const hist of history) {
+        try {
+          const normalizedHistory = {
+            ...hist,
+            karat: '925',
+            goldColor: hist.silverColor || 'é“¶è‰²',
+            goldPrice: hist.silverPrice || 20,
+          };
+
+          // æ£€æŸ¥å†å²è®°å½•æ˜¯å¦å·²å­˜åœ¨
+          const existing = await priceHistoryManager.getHistoryById(hist.id, user.id);
+          if (existing) {
+            // å·²å­˜åœ¨ï¼Œè·³è¿‡
+            continue;
+          }
+
+          // åˆ›å»ºå†å²è®°å½•
+          const { userId: _userId, createdAt: _createdAt, ...historyToInsert } = normalizedHistory as any;
+          await priceHistoryManager.createPriceHistoryWithId(user.id, { ...historyToInsert, id: hist.id });
+          syncedHistory++;
+        } catch (e) {
+          console.error('  âœ— åŒæ­¥å†å²è®°å½•å¤±è´¥:', hist.productCode || hist.id, e);
+        }
+      }
+      console.log(`âœ… é“¶åˆ¶å“å†å²è®°å½•åŒæ­¥å®Œæˆ: ${syncedHistory} æ¡`);
+    }
+
+    // 3. ä¿å­˜é…ç½®
+    if (silverPrice !== undefined) {
+      await appConfigManager.setConfig(user.id, 'silver_price_config', silverPrice);
+      console.log('âœ… é“¶ä»·é…ç½®å·²ä¿å­˜');
+    }
+
+    if (coefficients) {
+      await appConfigManager.setConfig(user.id, 'silver_price_coefficients', coefficients);
+      console.log('âœ… é“¶åˆ¶å“ä»·æ ¼ç³»æ•°å·²ä¿å­˜');
+    }
+
+    return NextResponse.json({
+      success: true,
+      syncedProducts,
+      updatedProducts,
+      newProducts,
+      syncedHistory,
+    });
   } catch (error) {
-    console.error('âŒ æ¸…é™¤é“¶åˆ¶å“æ•°æ®å¤±è´¥:', error);
+    console.error('é“¶åˆ¶å“åŒæ­¥å¤±è´¥:', error);
     return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
   }
 }
diff --git a/src/app/quote/page.tsx b/src/app/quote/page.tsx
index 43a6ca6..78a8046 100644
--- a/src/app/quote/page.tsx
+++ b/src/app/quote/page.tsx
@@ -515,6 +515,44 @@ function QuotePage() {
     return undefined;
   };
 
+  // æŸ¥æ‰¾æœ€å³è¾¹åŒ…å«å…³é”®è¯çš„åˆ—çš„å€¼ï¼ˆè‡ªåŠ¨é€‰æ‹©æœ€æ–°çš„ä¸€åˆ—ï¼‰
+  // ç”¨äºå¤„ç†Excelä¸­æœ‰å¤šåˆ—ç›¸åŒç±»å‹æ•°æ®çš„æƒ…å†µï¼ˆå¦‚é‡é‡1ã€é‡é‡2ã€é‡é‡3...ï¼‰
+  const findLatestGoldColumnValue = (row: any, headers: string[], chineseColumnName: string, keywords: string[]): any => {
+    // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„åˆ—ç´¢å¼•
+    const matchingIndices: number[] = [];
+
+    // å°è¯•æŸ¥æ‰¾ä¸­æ–‡åˆ—åçš„ç²¾ç¡®åŒ¹é…
+    const exactIndex = headers.findIndex(h => h && String(h).trim() === chineseColumnName);
+    if (exactIndex !== -1 && row[exactIndex] !== undefined) {
+      matchingIndices.push(exactIndex);
+    }
+
+    // å°è¯•æŸ¥æ‰¾è‹±æ–‡åˆ—å
+    const englishColumnName = GOLD_COLUMN_MAPPING[chineseColumnName];
+    if (englishColumnName) {
+      const englishIndex = headers.findIndex(h => h && String(h).trim() === englishColumnName);
+      if (englishIndex !== -1 && row[englishIndex] !== undefined) {
+        matchingIndices.push(englishIndex);
+      }
+    }
+
+    // å°è¯•æ¨¡ç³ŠåŒ¹é…å…³é”®è¯ï¼ˆä¸­æ–‡ï¼‰
+    for (const keyword of keywords) {
+      const fuzzyIndex = headers.findIndex(h => h && String(h).includes(keyword));
+      if (fuzzyIndex !== -1 && row[fuzzyIndex] !== undefined && !matchingIndices.includes(fuzzyIndex)) {
+        matchingIndices.push(fuzzyIndex);
+      }
+    }
+
+    if (matchingIndices.length === 0) {
+      return undefined;
+    }
+
+    // è¿”å›æœ€å³è¾¹ä¸€åˆ—çš„å€¼ï¼ˆæœ€æ–°çš„å€¼ï¼‰
+    const latestIndex = Math.max(...matchingIndices);
+    return row[latestIndex];
+  };
+
   // å¯¼å…¥Excelç›¸å…³çŠ¶æ€
   const [importWeight, setImportWeight] = useState<boolean>(true);
   const [importLaborCost, setImportLaborCost] = useState<boolean>(true);
@@ -4137,17 +4175,23 @@ function QuotePage() {
             }
           }
 
-          // å†å°è¯•æ¨¡ç³ŠåŒ¹é…
+          // å†å°è¯•æ¨¡ç³ŠåŒ¹é…ï¼Œè¿”å›æœ€å³è¾¹çš„åŒ¹é…åˆ—
+          const fuzzyIndices: number[] = [];
           for (const keyword of keywords) {
             const fuzzyIndex = headers.findIndex(h =>
               h && String(h).includes(keyword)
             );
-            if (fuzzyIndex !== -1) {
-              console.log(`åˆ— "${keyword}" æ¨¡ç³ŠåŒ¹é…åˆ°ç´¢å¼• ${fuzzyIndex} ("${headers[fuzzyIndex]}")`);
-              return fuzzyIndex;
+            if (fuzzyIndex !== -1 && !fuzzyIndices.includes(fuzzyIndex)) {
+              fuzzyIndices.push(fuzzyIndex);
             }
           }
 
+          if (fuzzyIndices.length > 0) {
+            const latestIndex = Math.max(...fuzzyIndices);
+            console.log(`åˆ— "${keywords.join(', ')}" æ¨¡ç³ŠåŒ¹é…åˆ°ç´¢å¼• ${latestIndex} (æœ€å³è¾¹) ("${headers[latestIndex]}")`);
+            return latestIndex;
+          }
+
           console.warn(`âš ï¸ æœªæ‰¾åˆ°åŒ…å«å…³é”®è¯ [${keywords.join(', ')}] çš„åˆ—`);
           return -1;
         };
diff --git a/src/app/silver-quote/page.tsx b/src/app/silver-quote/page.tsx
index a98ea26..1c3ce62 100644
--- a/src/app/silver-quote/page.tsx
+++ b/src/app/silver-quote/page.tsx
@@ -243,6 +243,41 @@ const getSilverColumnValue = (row: any, chineseColumnName: string): any => {
   return undefined;
 };
 
+// æŸ¥æ‰¾æœ€å³è¾¹åŒ…å«å…³é”®è¯çš„åˆ—çš„å€¼ï¼ˆè‡ªåŠ¨é€‰æ‹©æœ€æ–°çš„ä¸€åˆ—ï¼‰
+// ç”¨äºå¤„ç†Excelä¸­æœ‰å¤šåˆ—ç›¸åŒç±»å‹æ•°æ®çš„æƒ…å†µï¼ˆå¦‚é‡é‡1ã€é‡é‡2ã€é‡é‡3...ï¼‰
+const findLatestColumnValue = (row: any, chineseColumnName: string, ...keywords: string[]): any => {
+  const rowKeys = Object.keys(row);
+
+  // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„åˆ—
+  const matchingColumns = rowKeys.filter(key => {
+    const keyLower = String(key).toLowerCase();
+    // æ£€æŸ¥ä¸­æ–‡åˆ—å
+    if (chineseColumnName && keyLower === chineseColumnName.toLowerCase()) {
+      return true;
+    }
+    // æ£€æŸ¥è‹±æ–‡åˆ—å
+    const englishColumnName = SILVER_COLUMN_MAPPING[chineseColumnName];
+    if (englishColumnName && keyLower === englishColumnName.toLowerCase()) {
+      return true;
+    }
+    // æ£€æŸ¥å…³é”®è¯
+    for (const keyword of keywords) {
+      if (keyLower.includes(keyword.toLowerCase())) {
+        return true;
+      }
+    }
+    return false;
+  });
+
+  if (matchingColumns.length === 0) {
+    return undefined;
+  }
+
+  // è¿”å›æœ€å³è¾¹ä¸€åˆ—çš„å€¼ï¼ˆæœ€æ–°çš„å€¼ï¼‰
+  const latestColumn = matchingColumns[matchingColumns.length - 1];
+  return row[latestColumn];
+};
+
 // ========== é“¶åˆ¶å“è´§å·è¯†åˆ« ==========
 
 // åˆ¤æ–­æ˜¯å¦ä¸ºé“¶åˆ¶å“è´§å·
@@ -536,6 +571,10 @@ function SilverQuotePage() {
   const [currentCategory, setCurrentCategory] = useState<SilverProductCategory>("é…ä»¶");
   const [currentSubCategory, setCurrentSubCategory] = useState<string | null>(null);
 
+  // æœç´¢æŸ¥è¯¢
+  const [searchQuery, setSearchQuery] = useState<string>("");
+  const [searchTrigger, setSearchTrigger] = useState<number>(0);
+
   // æ‰¹é‡æ“ä½œçŠ¶æ€
   const [selectedProductIds, setSelectedProductIds] = useState<Set<string>>(new Set());
 
@@ -1009,7 +1048,7 @@ function SilverQuotePage() {
         importMode = window.confirm(message) ? "all" : "selected";
       }
 
-      // å¯¼å…¥äº§å“
+      // å¯¼å…¥äº§å“ - ä½¿ç”¨æ™ºèƒ½æŸ¥æ‰¾æœ€æ–°åˆ—çš„åŠŸèƒ½
       const importedProducts: SilverProduct[] = jsonData
         .filter((row: any) => {
           // å¦‚æœé€‰æ‹©äº†"ä»…å¯¼å…¥é€‰ä¸­åˆ†ç±»"ï¼Œåˆ™è¿‡æ»¤
@@ -1027,15 +1066,18 @@ function SilverQuotePage() {
           productCode: getSilverColumnValue(row, "è´§å·") || "",
           productName: getSilverColumnValue(row, "äº§å“åç§°") || "",
           specification: getSilverColumnValue(row, "è§„æ ¼") || "",
-          weight: Number(getSilverColumnValue(row, "å…‹é‡")) || 0,
-          laborCost: Number(getSilverColumnValue(row, "å·¥è´¹")) || 0,
+          // ğŸ”¥ è‡ªåŠ¨é€‰æ‹©æœ€å³è¾¹çš„é‡é‡åˆ—ï¼ˆæœ€æ–°çš„é‡é‡ï¼‰
+          weight: Number(findLatestColumnValue(row, "å…‹é‡", "é‡é‡", "å…‹é‡", "å‡€é‡", "é‡é‡(g)", "é‡é‡(å…‹)")) || 0,
+          // ğŸ”¥ è‡ªåŠ¨é€‰æ‹©æœ€å³è¾¹çš„å·¥è´¹åˆ—ï¼ˆæœ€æ–°çš„å·¥è´¹ï¼‰
+          laborCost: Number(findLatestColumnValue(row, "å·¥è´¹", "å·¥è´¹", "äººå·¥è´¹", "åŠ å·¥è´¹", "æ‰‹å·¥è´¹")) || 0,
           silverColor: getSilverColumnValue(row, "é“¶è‰²") || "é“¶è‰²",
           silverPrice: silverPrice,
           wholesalePrice: 0,
           retailPrice: 0,
-          accessoryCost: Number(getSilverColumnValue(row, "é…ä»¶æˆæœ¬")) || 0,
-          stoneCost: Number(getSilverColumnValue(row, "çŸ³å¤´æˆæœ¬")) || 0,
-          platingCost: Number(getSilverColumnValue(row, "ç”µé•€æˆæœ¬")) || 0,
+          // ğŸ”¥ è‡ªåŠ¨é€‰æ‹©æœ€å³è¾¹çš„æˆæœ¬åˆ—ï¼ˆæœ€æ–°çš„æˆæœ¬ï¼‰
+          accessoryCost: Number(findLatestColumnValue(row, "é…ä»¶æˆæœ¬", "é…ä»¶", "é…ä»¶æˆæœ¬")) || 0,
+          stoneCost: Number(findLatestColumnValue(row, "çŸ³å¤´æˆæœ¬", "çŸ³å¤´", "çŸ³å¤´æˆæœ¬")) || 0,
+          platingCost: Number(findLatestColumnValue(row, "ç”µé•€æˆæœ¬", "ç”µé•€", "ç”µé•€æˆæœ¬")) || 0,
           moldCost: 0,
           commission: 0,
           supplierCode: getSilverColumnValue(row, "ä¾›åº”å•†ä»£ç ") || "E1",
@@ -1114,9 +1156,18 @@ function SilverQuotePage() {
         <div className="max-w-7xl mx-auto">
           {/* é¡µé¢æ ‡é¢˜ */}
           <div className="mb-6 flex items-center justify-between">
-            <div>
-              <h1 className="text-3xl font-bold text-black mb-2">é“¶åˆ¶å“æŠ¥ä»·æ“ä½œå¹³å°</h1>
-              <p className="text-black">925é“¶åˆ¶å“ä»·æ ¼è®¡ç®—å’Œç®¡ç†ç³»ç»Ÿ</p>
+            <div className="flex items-center gap-4">
+              <div>
+                <h1 className="text-3xl font-bold text-black mb-2">é“¶åˆ¶å“æŠ¥ä»·æ“ä½œå¹³å°</h1>
+                <p className="text-black">925é“¶åˆ¶å“ä»·æ ¼è®¡ç®—å’Œç®¡ç†ç³»ç»Ÿ</p>
+              </div>
+              <button
+                onClick={() => router.push('/quote')}
+                className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 flex items-center gap-2"
+              >
+                <span>â†</span>
+                <span>è¿”å›é‡‘åˆ¶å“</span>
+              </button>
             </div>
             <div className="relative">
               <button
@@ -1207,6 +1258,40 @@ function SilverQuotePage() {
             </div>
           </div>
 
+          {/* æ“ä½œæŒ‡å¼• */}
+          <div className="bg-blue-50 rounded-lg shadow-md p-6 mb-6 border border-blue-200">
+            <h2 className="text-xl font-bold text-black mb-4 flex items-center gap-2">
+              <span>ğŸ“–</span>
+              <span>æ“ä½œæŒ‡å¼•</span>
+            </h2>
+            <div className="space-y-3 text-sm text-black">
+              <div className="flex gap-2">
+                <span className="font-bold text-blue-600">1. æ•°æ®å¯¼å…¥ï¼š</span>
+                <span>é€‰æ‹©äº§å“å°ç±»åå¯¼å…¥Excelæ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«åˆ†ç±»å’Œå­—æ®µ</span>
+              </div>
+              <div className="flex gap-2">
+                <span className="font-bold text-blue-600">2. äº§å“ç®¡ç†ï¼š</span>
+                <span>å¯ä»¥æ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤äº§å“ï¼Œæ‰¹é‡ä¿®æ”¹å·¥è´¹æˆ–åˆ é™¤</span>
+              </div>
+              <div className="flex gap-2">
+                <span className="font-bold text-blue-600">3. ä»·æ ¼è®¡ç®—ï¼š</span>
+                <span>ä¿®æ”¹å…‹é‡ã€å·¥è´¹ç­‰å‚æ•°åï¼Œç³»ç»Ÿè‡ªåŠ¨è®¡ç®—é›¶å”®ä»·å’Œæ‰¹å‘ä»·</span>
+              </div>
+              <div className="flex gap-2">
+                <span className="font-bold text-blue-600">4. äº‘ç«¯åŒæ­¥ï¼š</span>
+                <span>å¯å°†æ•°æ®ä¸Šä¼ åˆ°äº‘ç«¯ï¼Œæˆ–ä»äº‘ç«¯ä¸‹è½½æ•°æ®ï¼Œæ”¯æŒåˆå¹¶å’Œè¦†ç›–æ¨¡å¼</span>
+              </div>
+              <div className="flex gap-2">
+                <span className="font-bold text-blue-600">5. æ•°æ®å¯¼å‡ºï¼š</span>
+                <span>æ”¯æŒå¯¼å‡ºExcelæ–‡ä»¶ï¼Œæ–¹ä¾¿å¤‡ä»½å’Œåˆ†äº«</span>
+              </div>
+              <div className="flex gap-2">
+                <span className="font-bold text-blue-600">6. æ™ºèƒ½è¯†åˆ«ï¼š</span>
+                <span>è¾“å…¥è´§å·è‡ªåŠ¨è¯†åˆ«ä¾›åº”å•†ä»£ç ï¼Œè¾“å…¥äº§å“åç§°è‡ªåŠ¨è¯†åˆ«åˆ†ç±»</span>
+              </div>
+            </div>
+          </div>
+
           {/* é“¶ä»·é…ç½® */}
           <div className="bg-white rounded-lg shadow-md p-6 mb-6">
             <h2 className="text-xl font-bold text-black mb-4">é“¶ä»·é…ç½®</h2>
@@ -1368,57 +1453,12 @@ function SilverQuotePage() {
             </div>
           </div>
 
-          {/* æµ‹è¯•åŒºåŸŸ */}
-          <div className="bg-white rounded-lg shadow-md p-6 mb-6">
-            <h2 className="text-xl font-bold text-black mb-4">æµ‹è¯•è®¡ç®—</h2>
-            <button
-              onClick={() => {
-                const testProduct: SilverProduct = {
-                  id: "test",
-                  category: "é…ä»¶",
-                  subCategory: "æ‰£å­",
-                  productCode: "KEW001",
-                  productName: "æµ‹è¯•äº§å“",
-                  specification: "æµ‹è¯•è§„æ ¼",
-                  weight: 1.0,
-                  laborCost: 10,
-                  silverColor: "é“¶è‰²",
-                  silverPrice: 20,
-                  wholesalePrice: 0,
-                  retailPrice: 0,
-                  accessoryCost: 5,
-                  stoneCost: 10,
-                  platingCost: 5,
-                  moldCost: 0,
-                  commission: 0,
-                  supplierCode: "E1",
-                  remarks: "",
-                  batchQuantity: 0,
-                  quantity: 0,
-                  quantityDate: "",
-                  laborCostDate: "",
-                  accessoryCostDate: "",
-                  stoneCostDate: "",
-                  platingCostDate: "",
-                  moldCostDate: "",
-                  commissionDate: "",
-                  timestamp: new Date().toISOString(),
-                  syncStatus: "unsynced",
-                };
-
-                const retail = calculateSilverPrice(testProduct, true);
-                const wholesale = calculateSilverPrice(testProduct, false);
-
-                alert(`é›¶å”®ä»·: $${retail.toFixed(2)}\næ‰¹å‘ä»·: $${wholesale.toFixed(2)}`);
-              }}
-              className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
-            >
-              æµ‹è¯•è®¡ç®—
-            </button>
-          </div>
-
-          {/* äº§å“æ“ä½œåŒº */}
+          {/* äº§å“ç®¡ç†åŒº */}
           <div className="bg-white rounded-lg shadow-md p-6 mb-6">
+            <h2 className="text-xl font-bold text-black mb-4 flex items-center gap-2">
+              <span>ğŸ“¦</span>
+              <span>äº§å“ç®¡ç†åŒº</span>
+            </h2>
             <div className="flex items-center justify-between mb-4">
               <div>
                 <h2 className="text-xl font-bold text-black">äº§å“ç®¡ç†</h2>
@@ -1561,7 +1601,40 @@ function SilverQuotePage() {
 
           {/* äº§å“åˆ—è¡¨ */}
           <div className="bg-white rounded-lg shadow-md p-6 mb-6">
-            <h2 className="text-xl font-bold text-black mb-4">äº§å“åˆ—è¡¨</h2>
+            <div className="flex items-center justify-between mb-4">
+              <h2 className="text-xl font-bold text-black">äº§å“åˆ—è¡¨</h2>
+              <div className="flex items-center gap-2">
+                <input
+                  type="text"
+                  placeholder="æœç´¢è´§å·æˆ–äº§å“åç§°..."
+                  value={searchQuery}
+                  onChange={(e) => setSearchQuery(e.target.value)}
+                  onKeyUp={(e) => {
+                    if (e.key === 'Enter') {
+                      setSearchTrigger(Date.now());
+                    }
+                  }}
+                  className="border border-gray-300 rounded px-3 py-1.5 w-64 text-sm text-black"
+                />
+                <button
+                  onClick={() => setSearchTrigger(Date.now())}
+                  className="bg-blue-500 text-white px-3 py-1.5 rounded hover:bg-blue-600 text-sm"
+                >
+                  æœç´¢
+                </button>
+                {searchQuery && (
+                  <button
+                    onClick={() => {
+                      setSearchQuery('');
+                      setSearchTrigger(Date.now());
+                    }}
+                    className="text-gray-500 hover:text-gray-700 text-sm"
+                  >
+                    æ¸…é™¤
+                  </button>
+                )}
+              </div>
+            </div>
             <div className="overflow-x-auto">
               <table className="w-full border-collapse border border-gray-200 text-sm">
                 <thead className="bg-gray-100">
@@ -1609,6 +1682,13 @@ function SilverQuotePage() {
                   {products.filter(p => {
                     if (p.category !== currentCategory) return false;
                     if (currentSubCategory && p.subCategory !== currentSubCategory) return false;
+                    // æœç´¢è¿‡æ»¤
+                    if (searchQuery) {
+                      const query = searchQuery.toLowerCase();
+                      const matchesCode = p.productCode.toLowerCase().includes(query);
+                      const matchesName = p.productName.toLowerCase().includes(query);
+                      return matchesCode || matchesName;
+                    }
                     return true;
                   }).map(product => (
                     <tr key={product.id}>
@@ -1773,7 +1853,10 @@ function SilverQuotePage() {
 
           {/* å†å²è®°å½• */}
           <div className="bg-white rounded-lg shadow-md p-6 mb-6">
-            <h2 className="text-xl font-bold text-black mb-4">ä»·æ ¼å†å²è®°å½•</h2>
+            <h2 className="text-xl font-bold text-black mb-4 flex items-center gap-2">
+              <span>ğŸ“Š</span>
+              <span>æ•°æ®ç®¡ç†åŒº - ä»·æ ¼å†å²è®°å½•</span>
+            </h2>
             <div className="overflow-x-auto" style={{ maxHeight: '400px' }}>
               <table className="w-full border-collapse border border-gray-200 text-sm">
                 <thead className="bg-gray-100 sticky top-0">
@@ -1814,16 +1897,6 @@ function SilverQuotePage() {
               </table>
             </div>
           </div>
-
-          {/* è¿”å›é‡‘åˆ¶å“é¡µé¢ */}
-          <div className="text-center">
-            <button
-              onClick={() => router.push('/quote')}
-              className="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600"
-            >
-              è¿”å›é‡‘åˆ¶å“æŠ¥ä»·ç³»ç»Ÿ
-            </button>
-          </div>
         </div>
       </AuthProtection>
     </div>
-- 
2.43.0

