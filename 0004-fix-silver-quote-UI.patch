From 36ed0253fc88c63ae7d9ce7a5bce60163e664f90 Mon Sep 17 00:00:00 2001
From: Marblee <3440803185179952-Marblee@noreply.coze.cn>
Date: Wed, 7 Jan 2026 12:19:54 +0800
Subject: [PATCH 04/13] =?UTF-8?q?fix(silver-quote):=20=E4=BF=AE=E5=A4=8D?=
 =?UTF-8?q?=E4=BA=A7=E5=93=81=E5=88=97=E8=A1=A8=E9=A2=9C=E8=89=B2=E5=88=97?=
 =?UTF-8?q?=E6=98=BE=E7=A4=BA=E3=80=81=E4=BC=98=E5=8C=96=E4=BA=91=E7=AB=AF?=
 =?UTF-8?q?=E5=90=8C=E6=AD=A5UI=E3=80=81=E6=B7=BB=E5=8A=A0=E6=89=B9?=
 =?UTF-8?q?=E9=87=8F=E6=93=8D=E4=BD=9C=E5=8A=9F=E8=83=BD?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- ä¿®å¤é“¶è‰²åˆ—æ˜¾ç¤ºé—®é¢˜ï¼šæ·»åŠ æœ€å°å®½åº¦min-w-[160px]ï¼Œç¡®ä¿é“¶è‰²/é•€é‡‘/é•€ç«ç‘°é‡‘å®Œæ•´æ˜¾ç¤º
- é‡æ„äº‘ç«¯åŒæ­¥èœå•UIï¼šç¾åŒ–ç•Œé¢ï¼Œæ·»åŠ æ¸å˜å¤´éƒ¨ï¼Œæ¸…æ™°æ˜¾ç¤ºä¸Šä¼ /åˆå¹¶ä¸‹è½½/è¦†ç›–ä¸‹è½½/åŒæ­¥çŠ¶æ€
- æ–°å¢æ‰¹é‡æ“ä½œåŠŸèƒ½ï¼šæ·»åŠ å…¨é€‰å¤é€‰æ¡†ã€æ‰¹é‡é€‰æ‹©ã€æ‰¹é‡åˆ é™¤ã€æ‰¹é‡ç¼–è¾‘å·¥è´¹
- æ–°å¢æ•°æ®ç®¡ç†æŒ‰é’®ï¼šéªŒè¯æ•°æ®åŠŸèƒ½æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ï¼ŒåŒæ­¥æ•°æ®æŒ‰é’®å¿«é€Ÿæ‰“å¼€äº‘åŒæ­¥
- æ‰€æœ‰ä¿®æ”¹é€šè¿‡TypeScriptç±»å‹æ£€æŸ¥ï¼ŒæœåŠ¡æ­£å¸¸è¿è¡Œ
---
 src/app/silver-quote/page.tsx | 275 ++++++++++++++++++++++++++++------
 1 file changed, 227 insertions(+), 48 deletions(-)

diff --git a/src/app/silver-quote/page.tsx b/src/app/silver-quote/page.tsx
index 4c5eb01..b203da2 100644
--- a/src/app/silver-quote/page.tsx
+++ b/src/app/silver-quote/page.tsx
@@ -447,6 +447,75 @@ function SilverQuotePage() {
   const [currentCategory, setCurrentCategory] = useState<SilverProductCategory>("é…ä»¶");
   const [currentSubCategory, setCurrentSubCategory] = useState<string | null>(null);
 
+  // æ‰¹é‡æ“ä½œçŠ¶æ€
+  const [selectedProductIds, setSelectedProductIds] = useState<Set<string>>(new Set());
+
+  // æ‰¹é‡é€‰æ‹©æ“ä½œ
+  const toggleSelectAll = (checked: boolean) => {
+    const filtered = products.filter(p => {
+      if (p.category !== currentCategory) return false;
+      if (currentSubCategory && p.subCategory !== currentSubCategory) return false;
+      return true;
+    });
+    setSelectedProductIds(checked ? new Set(filtered.map(p => p.id)) : new Set());
+  };
+
+  const toggleSelectProduct = (id: string) => {
+    const newSelected = new Set(selectedProductIds);
+    if (newSelected.has(id)) {
+      newSelected.delete(id);
+    } else {
+      newSelected.add(id);
+    }
+    setSelectedProductIds(newSelected);
+  };
+
+  // æ‰¹é‡åˆ é™¤
+  const batchDelete = () => {
+    if (selectedProductIds.size === 0) {
+      alert("è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„äº§å“");
+      return;
+    }
+    if (window.confirm(`ç¡®è®¤åˆ é™¤é€‰ä¸­çš„ ${selectedProductIds.size} ä¸ªäº§å“ï¼Ÿ`)) {
+      const newProducts = products.filter(p => !selectedProductIds.has(p.id));
+      const newHistory = priceHistory.filter(h => !selectedProductIds.has(h.productId));
+      setProducts(newProducts);
+      setPriceHistory(newHistory);
+      saveToLocalStorage(newProducts, newHistory);
+      setSelectedProductIds(new Set());
+    }
+  };
+
+  // æ‰¹é‡ç¼–è¾‘ - ä¿®æ”¹å·¥è´¹
+  const batchEditLaborCost = () => {
+    if (selectedProductIds.size === 0) {
+      alert("è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„äº§å“");
+      return;
+    }
+    const newLaborCost = prompt(`è¯·è¾“å…¥æ–°çš„å·¥è´¹å€¼ï¼ˆå°†åº”ç”¨äº ${selectedProductIds.size} ä¸ªäº§å“ï¼‰:`);
+    if (newLaborCost === null || newLaborCost.trim() === "") return;
+
+    const laborCostNum = Number(newLaborCost);
+    if (isNaN(laborCostNum)) {
+      alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—");
+      return;
+    }
+
+    const updatedProducts = products.map(p => {
+      if (selectedProductIds.has(p.id)) {
+        const updated = { ...p, laborCost: laborCostNum };
+        updated.retailPrice = calculateSilverPrice(updated, true);
+        updated.wholesalePrice = calculateSilverPrice(updated, false);
+        return updated;
+      }
+      return p;
+    });
+
+    setProducts(updatedProducts);
+    saveToLocalStorage(updatedProducts);
+    alert(`å·²æ›´æ–° ${selectedProductIds.size} ä¸ªäº§å“çš„å·¥è´¹`);
+  };
+
   // æ·»åŠ äº§å“
   const addProduct = () => {
     const newProduct: SilverProduct = {
@@ -836,6 +905,29 @@ function SilverQuotePage() {
     reader.readAsBinaryString(file);
   };
 
+  // éªŒè¯æ•°æ®
+  const validateData = () => {
+    const errors: string[] = [];
+
+    products.forEach(p => {
+      if (!p.productName) {
+        errors.push(`è´§å· ${p.productCode || "æœªå¡«å†™"}ï¼šäº§å“åç§°ä¸ºç©º`);
+      }
+      if (p.weight <= 0) {
+        errors.push(`è´§å· ${p.productCode || "æœªå¡«å†™"}ï¼šå…‹é‡å¿…é¡»å¤§äº0`);
+      }
+      if (!p.productCode) {
+        errors.push(`äº§å“ ${p.productName || "æœªå¡«å†™"}ï¼šè´§å·ä¸ºç©º`);
+      }
+    });
+
+    if (errors.length === 0) {
+      alert(`âœ“ æ•°æ®éªŒè¯é€šè¿‡ï¼å…± ${products.length} ä¸ªäº§å“`);
+    } else {
+      alert(`âœ— å‘ç° ${errors.length} ä¸ªé—®é¢˜ï¼š\n\n${errors.slice(0, 10).join("\n")}${errors.length > 10 ? `\n...è¿˜æœ‰ ${errors.length - 10} ä¸ªé—®é¢˜` : ""}`);
+    }
+  };
+
   // ========== é¡µé¢UI ==========
 
   return (
@@ -854,61 +946,83 @@ function SilverQuotePage() {
                   setShowSyncMenu(!showSyncMenu);
                   checkCloudData();
                 }}
-                className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center gap-2"
+                className="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 flex items-center gap-2 shadow-md transition-all"
               >
-                <span>â˜ï¸</span>
-                <span>äº‘ç«¯åŒæ­¥</span>
+                <span className="text-lg">â˜ï¸</span>
+                <span className="font-medium">äº‘ç«¯åŒæ­¥</span>
               </button>
 
               {/* äº‘ç«¯åŒæ­¥èœå• */}
               {showSyncMenu && (
-                <div className="absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
-                  <div className="py-3">
-                    <div className="px-4 pb-2 border-b border-gray-200">
-                      <div className="text-sm font-semibold text-black">äº‘ç«¯æ•°æ®åŒæ­¥</div>
-                      {cloudDataExists && (
-                        <div className="text-xs text-green-600 mt-1">âœ“ äº‘ç«¯å·²æœ‰æ•°æ®</div>
-                      )}
+                <div className="absolute right-0 mt-3 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 z-50 overflow-hidden">
+                  {/* èœå•å¤´éƒ¨ - å§‹ç»ˆæ˜¾ç¤ºåŒæ­¥çŠ¶æ€ */}
+                  <div className="bg-gradient-to-r from-blue-500 to-blue-600 px-5 py-4">
+                    <div className="text-white font-bold text-lg mb-1">äº‘ç«¯æ•°æ®åŒæ­¥</div>
+                    <div className="flex items-center gap-2">
+                      <span className={`text-sm font-medium ${cloudDataExists ? "text-green-200" : "text-yellow-200"}`}>
+                        {cloudDataExists ? "â— äº‘ç«¯å·²æœ‰æ•°æ®" : "â—‹ äº‘ç«¯æš‚æ— æ•°æ®"}
+                      </span>
                     </div>
-
-                    {/* åŒæ­¥çŠ¶æ€æ¶ˆæ¯ */}
                     {syncStatus !== "idle" && (
-                      <div className="px-4 py-2">
-                        <div className={`text-sm ${syncStatus === "error" ? "text-red-600" : syncStatus === "success" ? "text-green-600" : "text-blue-600"}`}>
-                          {syncMessage}
-                        </div>
+                      <div className="mt-2 text-sm text-white bg-white/20 rounded px-3 py-2">
+                        {syncStatus === "syncing" && "â³ "}{syncStatus === "error" && "âŒ "}{syncStatus === "success" && "âœ… "}
+                        {syncMessage}
                       </div>
                     )}
+                  </div>
 
-                    <div className="px-4 py-2 space-y-1">
-                      <button
-                        onClick={uploadToCloud}
-                        disabled={syncStatus === "syncing"}
-                        className="w-full text-left px-3 py-2 rounded hover:bg-blue-50 text-black text-sm disabled:opacity-50"
-                      >
-                        ğŸ“¤ ä¸Šä¼ åˆ°äº‘ç«¯
-                      </button>
-                      <button
-                        onClick={() => downloadFromCloud("merge")}
-                        disabled={syncStatus === "syncing"}
-                        className="w-full text-left px-3 py-2 rounded hover:bg-green-50 text-black text-sm disabled:opacity-50"
-                      >
-                        ğŸ“¥ åˆå¹¶ä¸‹è½½ï¼ˆä¿ç•™æœ¬åœ°ï¼‰
-                      </button>
-                      <button
-                        onClick={() => downloadFromCloud("replace")}
-                        disabled={syncStatus === "syncing"}
-                        className="w-full text-left px-3 py-2 rounded hover:bg-orange-50 text-black text-sm disabled:opacity-50"
-                      >
-                        ğŸ”„ è¦†ç›–ä¸‹è½½ï¼ˆæ›¿æ¢æœ¬åœ°ï¼‰
-                      </button>
-                    </div>
+                  {/* æ“ä½œæŒ‰é’®åŒº */}
+                  <div className="p-4 space-y-2">
+                    <button
+                      onClick={uploadToCloud}
+                      disabled={syncStatus === "syncing"}
+                      className="w-full flex items-center justify-between px-4 py-3 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-blue-200"
+                    >
+                      <div className="flex items-center gap-3">
+                        <span className="text-xl">ğŸ“¤</span>
+                        <div className="text-left">
+                          <div className="font-semibold">ä¸Šä¼ åˆ°äº‘ç«¯</div>
+                          <div className="text-xs text-blue-600">å°†æœ¬åœ°æ•°æ®ä¸Šä¼ åˆ°æœåŠ¡å™¨</div>
+                        </div>
+                      </div>
+                      <span className="text-blue-400">â†’</span>
+                    </button>
 
-                    <div className="px-4 pt-2 border-t border-gray-200">
-                      <div className="text-xs text-gray-500">
-                        ä¸Šä¼ åŒ…å«ï¼šäº§å“æ•°æ®ã€å†å²è®°å½•ã€é“¶ä»·è®¾ç½®ã€ä»·æ ¼ç³»æ•°
+                    <button
+                      onClick={() => downloadFromCloud("merge")}
+                      disabled={syncStatus === "syncing"}
+                      className="w-full flex items-center justify-between px-4 py-3 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-green-200"
+                    >
+                      <div className="flex items-center gap-3">
+                        <span className="text-xl">ğŸ“¥</span>
+                        <div className="text-left">
+                          <div className="font-semibold">åˆå¹¶ä¸‹è½½</div>
+                          <div className="text-xs text-green-600">ä¿ç•™æœ¬åœ°æ•°æ®ï¼Œæ·»åŠ äº‘ç«¯æ•°æ®</div>
+                        </div>
                       </div>
-                    </div>
+                      <span className="text-green-400">â†’</span>
+                    </button>
+
+                    <button
+                      onClick={() => downloadFromCloud("replace")}
+                      disabled={syncStatus === "syncing"}
+                      className="w-full flex items-center justify-between px-4 py-3 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed border border-orange-200"
+                    >
+                      <div className="flex items-center gap-3">
+                        <span className="text-xl">ğŸ”„</span>
+                        <div className="text-left">
+                          <div className="font-semibold">è¦†ç›–ä¸‹è½½</div>
+                          <div className="text-xs text-orange-600">å®Œå…¨æ›¿æ¢æœ¬åœ°æ•°æ®</div>
+                        </div>
+                      </div>
+                      <span className="text-orange-400">â†’</span>
+                    </button>
+                  </div>
+
+                  {/* åº•éƒ¨è¯´æ˜ */}
+                  <div className="px-5 py-3 bg-gray-50 border-t border-gray-200">
+                    <div className="text-xs text-gray-600 font-medium mb-1">åŒæ­¥å†…å®¹åŒ…å«:</div>
+                    <div className="text-xs text-gray-500">äº§å“æ•°æ®ã€å†å²è®°å½•ã€é“¶ä»·è®¾ç½®ã€ä»·æ ¼ç³»æ•°</div>
                   </div>
                 </div>
               )}
@@ -1126,14 +1240,52 @@ function SilverQuotePage() {
           {/* äº§å“æ“ä½œåŒº */}
           <div className="bg-white rounded-lg shadow-md p-6 mb-6">
             <div className="flex items-center justify-between mb-4">
-              <h2 className="text-xl font-bold text-black">äº§å“ç®¡ç†</h2>
-              <div className="flex gap-2">
+              <div>
+                <h2 className="text-xl font-bold text-black">äº§å“ç®¡ç†</h2>
+                {selectedProductIds.size > 0 && (
+                  <div className="text-sm text-blue-600 mt-1">
+                    å·²é€‰æ‹© {selectedProductIds.size} ä¸ªäº§å“
+                  </div>
+                )}
+              </div>
+              <div className="flex gap-2 flex-wrap">
                 <button
                   onClick={addProduct}
                   className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                 >
                   æ·»åŠ äº§å“
                 </button>
+                {selectedProductIds.size > 0 && (
+                  <>
+                    <button
+                      onClick={batchEditLaborCost}
+                      className="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600"
+                    >
+                      æ‰¹é‡ä¿®æ”¹å·¥è´¹
+                    </button>
+                    <button
+                      onClick={batchDelete}
+                      className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
+                    >
+                      æ‰¹é‡åˆ é™¤
+                    </button>
+                  </>
+                )}
+                <button
+                  onClick={validateData}
+                  className="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600"
+                >
+                  éªŒè¯æ•°æ®
+                </button>
+                <button
+                  onClick={() => {
+                    setShowSyncMenu(!showSyncMenu);
+                    checkCloudData();
+                  }}
+                  className="bg-cyan-500 text-white px-4 py-2 rounded hover:bg-cyan-600"
+                >
+                  åŒæ­¥æ•°æ®
+                </button>
                 <button
                   onClick={exportToExcel}
                   className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
@@ -1198,13 +1350,32 @@ function SilverQuotePage() {
               <table className="w-full border-collapse border border-gray-200 text-sm">
                 <thead className="bg-gray-100">
                   <tr>
+                    <th className="border border-gray-200 px-3 py-2 text-center w-12">
+                      <input
+                        type="checkbox"
+                        checked={
+                          products.filter(p => {
+                            if (p.category !== currentCategory) return false;
+                            if (currentSubCategory && p.subCategory !== currentSubCategory) return false;
+                            return true;
+                          }).length > 0 &&
+                          products.filter(p => {
+                            if (p.category !== currentCategory) return false;
+                            if (currentSubCategory && p.subCategory !== currentSubCategory) return false;
+                            return true;
+                          }).every(p => selectedProductIds.has(p.id))
+                        }
+                        onChange={(e) => toggleSelectAll(e.target.checked)}
+                        className="w-4 h-4"
+                      />
+                    </th>
                     <th className="border border-gray-200 px-3 py-2 text-left text-black">æ“ä½œ</th>
                     <th className="border border-gray-200 px-3 py-2 text-left text-black">è´§å·</th>
                     <th className="border border-gray-200 px-3 py-2 text-left text-black">äº§å“åç§°</th>
                     <th className="border border-gray-200 px-3 py-2 text-left text-black">è§„æ ¼</th>
                     <th className="border border-gray-200 px-3 py-2 text-right text-black">å…‹é‡</th>
                     <th className="border border-gray-200 px-3 py-2 text-right text-black">å·¥è´¹</th>
-                    <th className="border border-gray-200 px-3 py-2 text-left text-black">é“¶è‰²</th>
+                    <th className="border border-gray-200 px-3 py-2 text-left text-black min-w-[160px]">é“¶è‰²</th>
                     <th className="border border-gray-200 px-3 py-2 text-right text-black">é…ä»¶æˆæœ¬</th>
                     <th className="border border-gray-200 px-3 py-2 text-right text-black">çŸ³å¤´æˆæœ¬</th>
                     <th className="border border-gray-200 px-3 py-2 text-right text-black">ç”µé•€æˆæœ¬</th>
@@ -1223,6 +1394,14 @@ function SilverQuotePage() {
                     return true;
                   }).map(product => (
                     <tr key={product.id}>
+                      <td className="border border-gray-200 px-3 py-2 text-center">
+                        <input
+                          type="checkbox"
+                          checked={selectedProductIds.has(product.id)}
+                          onChange={() => toggleSelectProduct(product.id)}
+                          className="w-4 h-4"
+                        />
+                      </td>
                       <td className="border border-gray-200 px-3 py-2">
                         <button
                           onClick={() => deleteProduct(product.id)}
@@ -1273,7 +1452,7 @@ function SilverQuotePage() {
                           className="w-full border border-gray-200 rounded px-2 py-1 text-black text-right"
                         />
                       </td>
-                      <td className="border border-gray-200 px-3 py-2">
+                      <td className="border border-gray-200 px-3 py-2 min-w-[160px]">
                         <select
                           value={product.silverColor}
                           onChange={(e) => updateProduct(product.id, "silverColor", e.target.value as any)}
@@ -1344,7 +1523,7 @@ function SilverQuotePage() {
                   ))}
                   {products.filter(p => p.category === currentCategory).length === 0 && (
                     <tr>
-                      <td colSpan={17} className="border border-gray-200 px-3 py-4 text-center text-black">
+                      <td colSpan={18} className="border border-gray-200 px-3 py-4 text-center text-black">
                         æš‚æ— {currentCategory}äº§å“æ•°æ®
                       </td>
                     </tr>
-- 
2.43.0

