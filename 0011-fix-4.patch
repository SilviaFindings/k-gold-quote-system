From 14e6e32e132300cc57b265db5af3bb1c220d4bdc Mon Sep 17 00:00:00 2001
From: Marblee <3440803185179952-Marblee@noreply.coze.cn>
Date: Wed, 7 Jan 2026 12:53:28 +0800
Subject: [PATCH 11/13] =?UTF-8?q?fix:=20=E4=BF=AE=E5=A4=8D=E9=93=B6?=
 =?UTF-8?q?=E5=88=B6=E5=93=81=E5=92=8C=E9=87=91=E5=88=B6=E5=93=81=E9=A1=B5?=
 =?UTF-8?q?=E9=9D=A2=E7=9A=844=E4=B8=AA=E9=97=AE=E9=A2=98?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 src/app/api/silver-sync/route.ts | 187 +++++++++++++++++++++++++++++++
 src/app/quote/page.tsx           |  28 +++++
 src/app/silver-quote/page.tsx    |  85 +++++++++++---
 3 files changed, 285 insertions(+), 15 deletions(-)
 create mode 100644 src/app/api/silver-sync/route.ts

diff --git a/src/app/api/silver-sync/route.ts b/src/app/api/silver-sync/route.ts
new file mode 100644
index 0000000..9ffd84a
--- /dev/null
+++ b/src/app/api/silver-sync/route.ts
@@ -0,0 +1,187 @@
+import { NextRequest, NextResponse } from 'next/server';
+import { isAuthenticated } from '@/lib/auth';
+
+// é“¶åˆ¶å“æ•°æ®ç±»å‹å®šä¹‰
+interface SilverProduct {
+  id: string;
+  category: string;
+  subCategory: string;
+  productCode: string;
+  productName: string;
+  specification: string;
+  weight: number;
+  laborCost: number;
+  silverColor: string;
+  silverPrice: number;
+  wholesalePrice: number;
+  retailPrice: number;
+  accessoryCost: number;
+  stoneCost: number;
+  platingCost: number;
+  moldCost: number;
+  commission: number;
+  supplierCode: string;
+  remarks: string;
+  batchQuantity: number;
+  quantity: number;
+  quantityDate: string;
+  laborCostDate: string;
+  accessoryCostDate: string;
+  stoneCostDate: string;
+  platingCostDate: string;
+  moldCostDate: string;
+  commissionDate: string;
+  timestamp: string;
+  syncStatus: "synced" | "unsynced";
+}
+
+interface SilverPriceHistory {
+  id: string;
+  productId: string;
+  category: string;
+  subCategory: string;
+  productCode: string;
+  productName: string;
+  specification: string;
+  weight: number;
+  laborCost: number;
+  silverColor: string;
+  silverPrice: number;
+  wholesalePrice: number;
+  retailPrice: number;
+  accessoryCost: number;
+  stoneCost: number;
+  platingCost: number;
+  moldCost: number;
+  commission: number;
+  supplierCode: string;
+  remarks: string;
+  batchQuantity: number;
+  quantity: number;
+  quantityDate: string;
+  laborCostDate: string;
+  accessoryCostDate: string;
+  stoneCostDate: string;
+  platingCostDate: string;
+  moldCostDate: string;
+  commissionDate: string;
+  timestamp: string;
+}
+
+// ç®€å•çš„å†…å­˜å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒåº”è¯¥ä½¿ç”¨æ•°æ®åº“ï¼‰
+let silverDataStore: {
+  products: SilverProduct[];
+  history: SilverPriceHistory[];
+  silverPrice: number;
+  coefficients: any;
+} = {
+  products: [],
+  history: [],
+  silverPrice: 20,
+  coefficients: {},
+};
+
+/**
+ * POST /api/silver-sync - ä¸Šä¼ é“¶åˆ¶å“æ•°æ®åˆ°äº‘ç«¯
+ * Body:
+ * - products: äº§å“æ•°ç»„
+ * - priceHistory: ä»·æ ¼å†å²æ•°ç»„
+ * - silverPrice: é“¶ä»·
+ * - coefficients: ç³»æ•°å¯¹è±¡
+ */
+export async function POST(request: NextRequest) {
+  try {
+    const user = await isAuthenticated(request);
+    if (!user) {
+      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
+    }
+
+    const body = await request.json();
+    const { products, priceHistory, silverPrice, coefficients } = body;
+
+    console.log('ğŸ“¥ æ”¶åˆ°é“¶åˆ¶å“åŒæ­¥è¯·æ±‚:', {
+      userId: user.id,
+      userEmail: user.email,
+      productsCount: Array.isArray(products) ? products.length : 0,
+      historyCount: Array.isArray(priceHistory) ? priceHistory.length : 0,
+    });
+
+    // å­˜å‚¨æ•°æ®åˆ°å†…å­˜ï¼ˆå®é™…åº”è¯¥ä½¿ç”¨æ•°æ®åº“ï¼‰
+    if (Array.isArray(products)) {
+      silverDataStore.products = products;
+    }
+    if (Array.isArray(priceHistory)) {
+      silverDataStore.history = priceHistory;
+    }
+    if (silverPrice !== undefined) {
+      silverDataStore.silverPrice = silverPrice;
+    }
+    if (coefficients) {
+      silverDataStore.coefficients = coefficients;
+    }
+
+    console.log('âœ… é“¶åˆ¶å“æ•°æ®ä¸Šä¼ æˆåŠŸ');
+    return NextResponse.json({ success: true });
+  } catch (error) {
+    console.error('âŒ é“¶åˆ¶å“åŒæ­¥å¤±è´¥:', error);
+    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
+  }
+}
+
+/**
+ * GET /api/silver-sync - ä»äº‘ç«¯ä¸‹è½½é“¶åˆ¶å“æ•°æ®
+ */
+export async function GET(request: NextRequest) {
+  try {
+    const user = await isAuthenticated(request);
+    if (!user) {
+      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
+    }
+
+    console.log('ğŸ“¤ å‘é€é“¶åˆ¶å“æ•°æ®:', {
+      userId: user.id,
+      userEmail: user.email,
+      productsCount: silverDataStore.products.length,
+      historyCount: silverDataStore.history.length,
+    });
+
+    return NextResponse.json({
+      products: silverDataStore.products,
+      history: silverDataStore.history,
+      silverPrice: silverDataStore.silverPrice,
+      coefficients: silverDataStore.coefficients,
+    });
+  } catch (error) {
+    console.error('âŒ é“¶åˆ¶å“ä¸‹è½½å¤±è´¥:', error);
+    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
+  }
+}
+
+/**
+ * DELETE /api/silver-sync - æ¸…é™¤äº‘ç«¯é“¶åˆ¶å“æ•°æ®
+ */
+export async function DELETE(request: NextRequest) {
+  try {
+    const user = await isAuthenticated(request);
+    if (!user) {
+      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
+    }
+
+    console.log('ğŸ—‘ï¸ æ¸…é™¤é“¶åˆ¶å“æ•°æ®:', {
+      userId: user.id,
+      userEmail: user.email,
+    });
+
+    silverDataStore = {
+      products: [],
+      history: [],
+      silverPrice: 20,
+      coefficients: {},
+    };
+
+    return NextResponse.json({ success: true });
+  } catch (error) {
+    console.error('âŒ æ¸…é™¤é“¶åˆ¶å“æ•°æ®å¤±è´¥:', error);
+    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
+  }
+}
diff --git a/src/app/quote/page.tsx b/src/app/quote/page.tsx
index ac50c2d..43a6ca6 100644
--- a/src/app/quote/page.tsx
+++ b/src/app/quote/page.tsx
@@ -6704,6 +6704,34 @@ function QuotePage() {
           </div>
         </div>
 
+        {/* è®¡ç®—å…¬å¼å±•ç¤º */}
+        <div className="rounded-lg bg-white p-6 shadow">
+          <h2 className="mb-4 text-xl font-bold text-black">è®¡ç®—å…¬å¼</h2>
+          <div className="space-y-4">
+            <div className="border-l-4 border-blue-500 pl-4">
+              <h3 className="mb-2 font-bold text-black">é€šç”¨é‡‘åˆ¶å“ï¼ˆåŠ å¸æŠ¥ä»·ï¼‰</h3>
+              <div className="space-y-2 rounded bg-gray-50 p-4 text-sm text-black">
+                <p><strong>ææ–™ä»·</strong> = é‡‘ä»· Ã— å…‹é‡ Ã— æˆè‰²å«é‡ Ã— 1.15 Ã— 1.1</p>
+                <p><strong>å…¶ä»–æˆæœ¬</strong> = (é…ä»¶ + çŸ³å¤´ + ç”µé•€ + ä½£é‡‘) Ã— 1.15</p>
+                <p><strong>ä½£é‡‘</strong> = å·¥è´¹ Ã— ä½£é‡‘ç‡ï¼ˆé»˜è®¤10%ï¼‰</p>
+                <p><strong>é›¶å”®ä»·</strong> = (ææ–™ä»· + å·¥è´¹ Ã— 5 + å…¶ä»–æˆæœ¬) Ã— 1.25 / 5</p>
+                <p><strong>æ‰¹å‘ä»·</strong> = (ææ–™ä»· + å·¥è´¹ Ã— 3 + å…¶ä»–æˆæœ¬) Ã— 1.25 / 5</p>
+              </div>
+            </div>
+            <div className="border-l-4 border-green-500 pl-4">
+              <h3 className="mb-2 font-bold text-black">Tå­—å¤´ä¾›åº”å•†ï¼ˆç‰¹æ®Šå…¬å¼ï¼‰</h3>
+              <div className="space-y-2 rounded bg-gray-50 p-4 text-sm text-black">
+                <p><strong>ææ–™ä»·</strong> = é‡‘ä»· Ã— å…‹é‡ Ã— æè´¨ç³»æ•°(14Kä¸º0.585) Ã— 1.15 Ã— 1.1 Ã— (1 + æŸè€—ç™¾åˆ†æ¯”)</p>
+                <p><strong>å…¶ä»–æˆæœ¬</strong> = (é…ä»¶ + çŸ³å¤´ + ç”µé•€ + ä½£é‡‘) Ã— SFææ–™æŸè€—ç³»æ•°(1.15)</p>
+                <p><strong>ä½£é‡‘</strong> = å·¥è´¹ Ã— ä½£é‡‘ç‡ï¼ˆé»˜è®¤10%ï¼‰</p>
+                <p><strong>é›¶å”®ä»·</strong> = (ææ–™ä»· + å·¥è´¹ Ã— 5 + å…¶ä»–æˆæœ¬) Ã— 1.35 + æ¨¡å…·è´¹</p>
+                <p><strong>æ‰¹å‘ä»·</strong> = (ææ–™ä»· + å·¥è´¹ Ã— 3 + å…¶ä»–æˆæœ¬) Ã— 1.35 + æ¨¡å…·è´¹</p>
+                <p className="mt-2 text-black"><strong>ğŸ’° æ³¨æ„</strong>ï¼šTå­—å¤´ä¾›åº”å•†ä½¿ç”¨ç¾é‡‘æŠ¥ä»·ï¼Œä½†é¡µé¢ç»Ÿä¸€æ˜¾ç¤ºåŠ å¸ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¿›è¡Œæ±‡ç‡è½¬æ¢ï¼ˆ1ç¾é‡‘ = 1.4åŠ å¸ï¼‰</p>
+              </div>
+            </div>
+          </div>
+        </div>
+
         <div className="grid gap-6 lg:grid-cols-2">
           {/* äº§å“å½•å…¥åŒºåŸŸ */}
           <div className="rounded-lg bg-white p-6 shadow">
diff --git a/src/app/silver-quote/page.tsx b/src/app/silver-quote/page.tsx
index 48f4b93..043f5a0 100644
--- a/src/app/silver-quote/page.tsx
+++ b/src/app/silver-quote/page.tsx
@@ -740,6 +740,9 @@ function SilverQuotePage() {
   const [syncStatus, setSyncStatus] = useState<"idle" | "syncing" | "success" | "error">("idle");
   const [syncMessage, setSyncMessage] = useState("");
 
+  // å¯¼å…¥Excelç›¸å…³çŠ¶æ€
+  const [importSubCategory, setImportSubCategory] = useState<string>(""); // å¯¼å…¥å‰é€‰æ‹©çš„å­åˆ†ç±»
+
   // æ£€æŸ¥äº‘ç«¯æ•°æ®æ˜¯å¦å­˜åœ¨
   const checkCloudData = async () => {
     try {
@@ -749,7 +752,7 @@ function SilverQuotePage() {
         return;
       }
 
-      const response = await fetch('/api/silver-products?limit=1', {
+      const response = await fetch('/api/silver-sync', {
         headers: {
           Authorization: `Bearer ${token}`,
         }
@@ -757,7 +760,7 @@ function SilverQuotePage() {
 
       if (response.ok) {
         const data = await response.json();
-        setCloudDataExists(data && data.length > 0);
+        setCloudDataExists(data && data.products && data.products.length > 0);
       }
     } catch (error) {
       console.error('æ£€æŸ¥äº‘ç«¯æ•°æ®å¤±è´¥:', error);
@@ -959,6 +962,13 @@ function SilverQuotePage() {
     const file = e.target.files?.[0];
     if (!file) return;
 
+    // ğŸ”¥ æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å­åˆ†ç±»
+    if (!importSubCategory) {
+      alert("âš ï¸ è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„äº§å“å°ç±»ï¼\n\nåœ¨é¡µé¢å·¦ä¾§çš„'å¯¼å…¥é€‰é¡¹'åŒºåŸŸé€‰æ‹©äº§å“å°ç±»åå†å¯¼å…¥ã€‚");
+      e.target.value = ""; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
+      return;
+    }
+
     const reader = new FileReader();
     reader.onload = (event) => {
       const data = event.target?.result;
@@ -967,36 +977,45 @@ function SilverQuotePage() {
       const sheet = workbook.Sheets[sheetName];
       const jsonData = XLSX.utils.sheet_to_json(sheet);
 
+      // è·å–ç”¨æˆ·é€‰æ‹©çš„å­åˆ†ç±»å¯¹åº”çš„å¤§åˆ†ç±»
+      let importCategory: SilverProductCategory = currentCategory;
+      for (const [cat, subList] of Object.entries(SILVER_SUB_CATEGORIES)) {
+        if (subList.includes(importSubCategory)) {
+          importCategory = cat as SilverProductCategory;
+          break;
+        }
+      }
+
       // æ£€æŸ¥Excelä¸­æ˜¯å¦åŒ…å«"åˆ†ç±»"åˆ—
-      const hasCategoryColumn = jsonData.length > 0 && (jsonData[0] as any)["åˆ†ç±»"] !== undefined;
+      const hasCategoryColumn = jsonData.length > 0 && getSilverColumnValue(jsonData[0] as any, "åˆ†ç±»") !== undefined;
       const categoriesInFile = hasCategoryColumn
-        ? [...new Set(jsonData.map((row: any) => row["åˆ†ç±»"]).filter(cat => cat))]
+        ? [...new Set(jsonData.map((row: any) => getSilverColumnValue(row, "åˆ†ç±»")).filter(cat => cat))]
         : [];
 
       // ç¡®è®¤å¯¼å…¥æ–¹å¼
-      let importMode: "all" | "current" = "all";
+      let importMode: "all" | "selected" = "selected";
 
       if (hasCategoryColumn && categoriesInFile.length > 0) {
         // Excelä¸­æœ‰åˆ†ç±»åˆ—ï¼Œè¯¢é—®ç”¨æˆ·å¯¼å…¥æ¨¡å¼
-        const message = `æ£€æµ‹åˆ°Excelæ–‡ä»¶åŒ…å«ä»¥ä¸‹åˆ†ç±»ï¼š\n${categoriesInFile.join(", ")}\n\nè¯·é€‰æ‹©å¯¼å…¥æ–¹å¼ï¼š\nâ€¢ ç‚¹å‡»"ç¡®å®š"ï¼šå¯¼å…¥æ‰€æœ‰åˆ†ç±»çš„äº§å“\nâ€¢ ç‚¹å‡»"å–æ¶ˆ"ï¼šä»…å¯¼å…¥å½“å‰é€‰ä¸­åˆ†ç±»ï¼ˆ${currentCategory}ï¼‰çš„äº§å“`;
-        importMode = window.confirm(message) ? "all" : "current";
+        const message = `æ£€æµ‹åˆ°Excelæ–‡ä»¶åŒ…å«ä»¥ä¸‹åˆ†ç±»ï¼š\n${categoriesInFile.join(", ")}\n\nè¯·é€‰æ‹©å¯¼å…¥æ–¹å¼ï¼š\nâ€¢ ç‚¹å‡»"ç¡®å®š"ï¼šå¯¼å…¥æ‰€æœ‰åˆ†ç±»çš„äº§å“\nâ€¢ ç‚¹å‡»"å–æ¶ˆ"ï¼šä»…å¯¼å…¥æ‚¨é€‰æ‹©çš„å­åˆ†ç±»ï¼ˆ${importSubCategory}ï¼‰çš„äº§å“`;
+        importMode = window.confirm(message) ? "all" : "selected";
       }
 
       // å¯¼å…¥äº§å“
       const importedProducts: SilverProduct[] = jsonData
         .filter((row: any) => {
-          // å¦‚æœé€‰æ‹©äº†"ä»…å¯¼å…¥å½“å‰åˆ†ç±»"ï¼Œåˆ™è¿‡æ»¤
-          if (importMode === "current") {
-            const rowCategory = getSilverColumnValue(row, "åˆ†ç±»");
-            if (!rowCategory) return false; // æ²¡æœ‰åˆ†ç±»çš„ä¹Ÿä¸å¯¼å…¥
-            return rowCategory === currentCategory;
+          // å¦‚æœé€‰æ‹©äº†"ä»…å¯¼å…¥é€‰ä¸­åˆ†ç±»"ï¼Œåˆ™è¿‡æ»¤
+          if (importMode === "selected") {
+            const rowSubCategory = getSilverColumnValue(row, "å­åˆ†ç±»");
+            if (!rowSubCategory) return false; // æ²¡æœ‰å­åˆ†ç±»çš„ä¹Ÿä¸å¯¼å…¥
+            return rowSubCategory === importSubCategory;
           }
           return true;
         })
         .map((row: any, index) => ({
           id: Date.now().toString() + index,
-          category: getSilverColumnValue(row, "åˆ†ç±»") || currentCategory,
-          subCategory: getSilverColumnValue(row, "å­åˆ†ç±»") || SILVER_SUB_CATEGORIES[(getSilverColumnValue(row, "åˆ†ç±»") as SilverProductCategory) || currentCategory]?.[0] || "",
+          category: importMode === "all" ? (getSilverColumnValue(row, "åˆ†ç±»") || importCategory) : importCategory,
+          subCategory: importMode === "all" ? (getSilverColumnValue(row, "å­åˆ†ç±»") || importSubCategory) : importSubCategory,
           productCode: getSilverColumnValue(row, "è´§å·") || "",
           productName: getSilverColumnValue(row, "äº§å“åç§°") || "",
           specification: getSilverColumnValue(row, "è§„æ ¼") || "",
@@ -1450,9 +1469,45 @@ function SilverQuotePage() {
                   <input type="file" accept=".xlsx,.xls" onChange={handleExcelImport} className="hidden" />
                 </label>
               </div>
+
+            {/* å¯¼å…¥é€‰é¡¹ */}
+            <div className="rounded-lg bg-gray-50 border-2 border-blue-200 p-3">
+              <p className="mb-2 text-sm font-medium text-black">å¯¼å…¥é€‰é¡¹ï¼š</p>
+              <div className="space-y-3">
+                <div className="rounded-lg border-2 border-blue-200 bg-blue-50 p-3">
+                  <label className="block text-sm font-semibold text-black mb-2">
+                    ğŸ¯ é€‰æ‹©äº§å“å°ç±»ï¼ˆå¯¼å…¥å‰å¿…é€‰ï¼‰
+                  </label>
+                  <p className="text-xs text-black mb-2">
+                    é€‰æ‹©è¦å¯¼å…¥çš„äº§å“å°ç±»ï¼Œç³»ç»Ÿå°†ä½¿ç”¨æ‚¨é€‰æ‹©çš„å°ç±»
+                  </p>
+                  <select
+                    value={importSubCategory}
+                    onChange={(e) => setImportSubCategory(e.target.value)}
+                    className="w-full rounded border-2 border-blue-300 px-3 py-2 bg-white focus:border-blue-500 focus:outline-none text-black font-medium"
+                  >
+                    <option value="">è¯·é€‰æ‹©äº§å“å°ç±»...</option>
+                    {Object.entries(SILVER_SUB_CATEGORIES).map(([category, subCats]) => (
+                      <optgroup key={category} label={category}>
+                        {subCats.map(subCat => (
+                          <option key={subCat} value={subCat}>
+                            {subCat}
+                          </option>
+                        ))}
+                      </optgroup>
+                    ))}
+                  </select>
+                  {!importSubCategory && (
+                    <p className="mt-2 text-xs text-red-600">
+                      âš ï¸ è¯·å…ˆé€‰æ‹©äº§å“å°ç±»å†å¯¼å…¥ï¼
+                    </p>
+                  )}
+                </div>
+              </div>
             </div>
+          </div>
 
-            {/* åˆ†ç±»é€‰æ‹© */}
+          {/* åˆ†ç±»é€‰æ‹© */}
             <div className="flex items-center gap-4 mb-4">
               <span className="text-black font-medium">é€‰æ‹©åˆ†ç±»:</span>
               <div className="flex gap-2">
-- 
2.43.0

